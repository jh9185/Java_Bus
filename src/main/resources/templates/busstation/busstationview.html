<html xmlns xmlns:th="http://www.w3.org/1999/xhtml" : th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=t8y7kns73m"></script>
    <title>버스 정류장 조회</title>
</head>
<body>
<div class="container">
    <div id="map" style="width:100%;height:400px;">
    </div>
    <script th:inline="javascript">
        /*<![CDATA[*/
        let locations = new Array();
        let markers = new Array();
        let infoWindows = new Array();
        let polylinePaths = new Array();
        let polylineTransPaths = new Array();
        let transValue = 0;

        let list = [[${busstationlist}]];

        let map = new naver.maps.Map('map', {
            center: new naver.maps.LatLng([[${busstationscenter.y}]], [[${busstationscenter.x}]]),
            zoom: 12
        });

        for (let j = 0; j < list.length; j++) {
            locations.push({location: list[j].stStationNm, lat: list[j].posY, lng: list[j].posX});

            if(list[j].transYn == "Y")
                transValue = j;
        }


        for (let i = 0; i < locations.length; i++) {
            let marker = new naver.maps.Marker({
                map: map,
                title: locations[i].location,
                position: new naver.maps.LatLng(locations[i].lat, locations[i].lng)
            });

            var myaddress = i+1 + " " + marker.title;

            let infoWindow = new naver.maps.InfoWindow({
                content: '<div style="width:150px;text-align:center;padding:5px;"><b>' + myaddress + '</b><br></div>'
            }); // 클릭했을 때 띄워줄 정보 HTML 작성

            if(i > transValue){
                let polyTransPath = new naver.maps.LatLng(locations[i].lat, locations[i].lng);
                polylineTransPaths.push(polyTransPath);
            }
            else if(i == transValue){
                let polyTransPath = new naver.maps.LatLng(locations[i].lat, locations[i].lng);
                let polyPath = new naver.maps.LatLng(locations[i].lat, locations[i].lng);
                polylineTransPaths.push(polyTransPath);
                polylinePaths.push(polyPath);
            }
            else{
                let polyPath = new naver.maps.LatLng(locations[i].lat, locations[i].lng);
                polylinePaths.push(polyPath);
            }

            markers.push(marker); // 생성한 마커를 배열에 담는다.
            infoWindows.push(infoWindow); // 생성한 정보창을 배열에 담는다.
        }


        function getClickHandler(seq) {

            return function(e) {  // 마커를 클릭하는 부분
                let marker = markers[seq], // 클릭한 마커의 시퀀스로 찾는다.
                    infoWindow = infoWindows[seq]; // 클릭한 마커의 시퀀스로 찾는다

                if (infoWindow.getMap()) {
                    infoWindow.close();
                } else {
                    infoWindow.open(map, marker); // 표출
                }
            }
        }

        let polyline = new naver.maps.Polyline({
            map: map,
            path: polylinePaths,
            strokeColor: '#E51D1A',
            strokeStyle: 'solid',
            strokeOpacity: 1,
            strokeWeight: 5
        });

        let polylinetrans = new naver.maps.Polyline({
            map: map,
            path: polylineTransPaths,
            strokeColor: '#1a3ce5',
            strokeStyle: 'solid',
            strokeOpacity: 1,
            strokeWeight: 5
        });


        for (let i=0, ii=markers.length; i<ii; i++) {
            console.log(markers[i] , getClickHandler(i));
            naver.maps.Event.addListener(markers[i], 'click', getClickHandler(i)); // 클릭한 마커 핸들러
            naver.maps.Event.addListener(markers[i], 'mouseover', getClickHandler(i));
        }

        /*]]>*/
    </script>
    <table id="busstationboard" class="table table-hover">
        <thead>
        <tr>
            <th>버스 ID</th>
            <th>버스 번호</th>
            <th>정류장 번호</th>
            <th>정류장 이름</th>
            <th>도착 정보</th>
            <th>도착 버스번호</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="busstationlist :${busstationlist}">
            <td>[[${busstationlist.busRouteId}]]</td>
            <td>[[${busstationlist.busRouteNm}]]</td>
            <td>[[${busstationlist.number}]]</td>
            <td>[[${busstationlist.StStationNm}]]</td>
            <td>[[${busstationlist.arrmsg}]]<br>
                [[${busstationlist.arrmsg2}]]</td>
            <td>[[${busstationlist.plainNo1}]]<br>
                [[${busstationlist.plainNo2}]]</td>
        </tr>
        </tbody>
    </table>
</div>
</body>
</html>